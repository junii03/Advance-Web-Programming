name: Deploy Backend

on:
    push:
        branches: ["main"]

jobs:
    deploy:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout repository
              uses: actions/checkout@v3

            - name: Setup Node
              uses: actions/setup-node@v3
              with:
                  node-version: "22"

            - name: Install backend dependencies
              working-directory: ./Project/backend
              run: npm install

            - name: Build backend (if applicable)
              working-directory: ./Project/backend
              run: |
                  if [ -f package.json ] && [ -n "$(jq -r '.scripts.build // empty' package.json)" ]; then
                    npm run build
                  else
                    echo "No build script. Skipping build."
                  fi

            - name: Deploy to EC2 via SSH
              uses: appleboy/ssh-action@v1.0.3
              with:
                  host: ${{ secrets.EC2_HOST }}
                  username: ubuntu
                  key: ${{ secrets.EC2_SSH_KEY }}
                  port: 22
                  timeout: 30s
                  command_timeout: 10m
                  script: |
                      cd /home/ubuntu/Advance-Web-Programming/Project/backend || exit 1

                      # Pull latest changes
                      git pull origin main || echo "Git pull failed, continuing..."

                      # Install dependencies
                      npm install

                      # Set environment variables from GitHub secrets
                      export NODE_ENV=${{ secrets.NODE_ENV }}
                      export PORT=${{ secrets.PORT }}
                      export MONGODB_URI=${{ secrets.MONGODB_URI }}
                      export REDIS_URL=${{ secrets.REDIS_URL }}
                      export JWT_SECRET=${{ secrets.JWT_SECRET }}
                      export BCRYPT_SALT_ROUNDS=${{ secrets.BCRYPT_SALT_ROUNDS }}
                      export CLOUDINARY_NAME=${{ secrets.CLOUDINARY_NAME }}
                      export CLOUDINARY_API_KEY=${{ secrets.CLOUDINARY_API_KEY }}
                      export CLOUDINARY_API_SECRET=${{ secrets.CLOUDINARY_API_SECRET }}
                      export CORS_ORIGIN=${{ secrets.CORS_ORIGIN }}
                      export SWAGGER_USERNAME=${{ secrets.SWAGGER_USERNAME }}
                      export SWAGGER_PASSWORD=${{ secrets.SWAGGER_PASSWORD }}

                      # Restart backend with PM2
                      pm2 restart backend-api || pm2 start app.js --name backend-api
                      pm2 save
